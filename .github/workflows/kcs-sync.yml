name: KCS Knowledge Base Sync
on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  sync-to-bookstack:
    runs-on: ubuntu-latest
    # –ò–ó–ú–ï–ù–ò–õ–ò: –∏—Å–ø–æ–ª—å–∑—É–µ–º contains() –≤–º–µ—Å—Ç–æ ==
    if: contains(github.event.issue.labels.*.name, 'knowledge-base')
    steps:
      - name: Debug - Show Labels
        run: |
          echo "=== DEBUG: Issue Information ==="
          echo "Issue #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"
          echo "Label names: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "Has 'knowledge-base' label: ${{ contains(github.event.issue.labels.*.name, 'knowledge-base') }}"

      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install marked
          sudo apt-get update && sudo apt-get install -y jq

      - name: Generate HTML from Markdown
        id: generate_html
        run: |
          echo "ISSUE_BODY<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.issue.body }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          node -e "
            const { marked } = require('marked');
            const issueBody = process.env.ISSUE_BODY || '';
            const html = marked.parse(issueBody);
            console.log('HTML_CONTENT=' + encodeURIComponent(html));
          " >> $GITHUB_ENV

      - name: Get Book ID for "Githab Issues"
        id: get_book_id
        env:
          API_ID: ${{ secrets.BOOKSTACK_API_ID }}
          API_SECRET: ${{ secrets.BOOKSTACK_API_SECRET }}
          BOOKSTACK_URL: ${{ secrets.BOOKSTACK_URL }}
        run: |
          echo "–ü–æ–ª—É—á–∞–µ–º ID –∫–Ω–∏–≥–∏ 'Githab Issues'..."
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–Ω–∏–≥
          response=$(curl -s -X GET "$BOOKSTACK_URL/api/books" \
            -H "Authorization: Token $API_ID:$API_SECRET")
          
          echo "API Response: $response"
          
          # –ò—â–µ–º –∫–Ω–∏–≥—É –ø–æ –∏–º–µ–Ω–∏
          book_id=$(echo $response | jq -r '.data[] | select(.name == "Githab Issues") | .id')
          
          if [ -z "$book_id" ]; then
            echo "‚ùå –ö–Ω–∏–≥–∞ 'Githab Issues' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            echo "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É..."
            
            create_response=$(curl -s -X POST "$BOOKSTACK_URL/api/books" \
              -H "Authorization: Token $API_ID:$API_SECRET" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "Githab Issues",
                "description": "GitHub Issues synchronized via KCS"
              }')
            
            book_id=$(echo $create_response | jq -r '.id')
            echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∫–Ω–∏–≥–∞ —Å ID: $book_id"
          else
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–∏–≥–∞ 'Githab Issues' —Å ID: $book_id"
          fi
          
          echo "BOOK_ID=$book_id" >> $GITHUB_OUTPUT

      - name: Create or Update BookStack Page
        env:
          API_ID: ${{ secrets.BOOKSTACK_API_ID }}
          API_SECRET: ${{ secrets.BOOKSTACK_API_SECRET }}
          BOOKSTACK_URL: ${{ secrets.BOOKSTACK_URL }}
        run: |
          BOOK_ID=${{ steps.get_book_id.outputs.BOOK_ID }}
          
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Book ID: $BOOK_ID"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          if [ "${{ github.event.action }}" = "closed" ]; then
            STATUS="‚úÖ –†–µ—à–µ–Ω–æ"
          elif [ "${{ github.event.action }}" = "reopened" ]; then
            STATUS="üîÑ –í —Ä–∞–±–æ—Ç–µ"
          else
            STATUS="üîÑ –í —Ä–∞–±–æ—Ç–µ"
          fi
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
          CONTENT="<p><strong>GitHub Issue:</strong> <a href='${{ github.event.issue.html_url }}'>#${{ github.event.issue.number }}</a></p>"
          CONTENT="$CONTENT<div>$HTML_CONTENT</div>"
          CONTENT="$CONTENT<p><strong>–°—Ç–∞—Ç—É—Å:</strong> $STATUS</p>"
          
          echo "–ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          EXISTING_PAGE=$(curl -s -X GET "$BOOKSTACK_URL/api/pages?book_id=$BOOK_ID" \
            -H "Authorization: Token $API_ID:$API_SECRET" \
            | jq -r ".data[] | select(.name == \"${{ github.event.issue.title }}\") | .id")
          
          if [ -z "$EXISTING_PAGE" ]; then
            echo "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É: ${{ github.event.issue.title }}"
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è JSON
            ESCAPED_CONTENT=$(echo "$CONTENT" | sed 's/"/\\"/g')
            
            curl -X POST "$BOOKSTACK_URL/api/pages" \
              -H "Authorization: Token $API_ID:$API_SECRET" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"${{ github.event.issue.title }}\",
                \"book_id\": $BOOK_ID,
                \"html\": \"$ESCAPED_CONTENT\",
                \"tags\": [
                  {\"name\": \"github\", \"value\": \"issue-${{ github.event.issue.number }}\"},
                  {\"name\": \"source\", \"value\": \"github-actions\"}
                ]
              }" && echo "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ" || echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏"
          else
            echo "–û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ID: $EXISTING_PAGE"
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è JSON
            ESCAPED_CONTENT=$(echo "$CONTENT" | sed 's/"/\\"/g')
            
            curl -X PUT "$BOOKSTACK_URL/api/pages/$EXISTING_PAGE" \
              -H "Authorization: Token $API_ID:$API_SECRET" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"${{ github.event.issue.title }}\",
                \"html\": \"$ESCAPED_CONTENT\"
              }" && echo "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞" || echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏"
          fi
